name: Windows Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Locate and add MSBuild to PATH
        shell: pwsh
        run: |
          $vswhere = "C:\\Program Files (x86)\\Microsoft Visual Studio\\Installer\\vswhere.exe"
          if (-Not (Test-Path $vswhere)) {
            Write-Error "vswhere.exe not found at $vswhere"
            exit 1
          }
          $msbuild = & $vswhere -latest -products * -requires Microsoft.Component.MSBuild -find '**\\MSBuild\\**\\Bin\\MSBuild.exe'
          if (-not $msbuild) {
            Write-Error "MSBuild.exe not found via vswhere"
            exit 1
          }
          Write-Host "MSBuild found at: $msbuild"
          $msbuildDir = Split-Path $msbuild -Parent
          Write-Host "Adding to PATH: $msbuildDir"
          "${msbuildDir}" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Build Release x64 (GUI)
        run: |
          msbuild PUBG_mortar.sln /p:Configuration=Release /p:Platform=x64 /p:OutDir=artifacts\x64\ /t:Build /m
        shell: cmd

      - name: Build Release x86 (Console)
        run: |
          msbuild PUBG_mortar.sln /p:Configuration=Release /p:Platform=x86 /p:OutDir=artifacts\x86\ /t:Build /m
        shell: cmd

      - name: Prepare artifacts folder and rename executables
        shell: pwsh
        run: |
          mkdir artifacts\release
          Write-Host "Looking for built executables..."
          $searchPaths64 = @('artifacts\x64','PUBG_mortar\artifacts\x64')
          $exe64 = $null
          foreach ($p in $searchPaths64) {
            if (Test-Path $p) {
              $exe64 = Get-ChildItem -Path $p -Filter *.exe -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
              if ($exe64) { break }
            }
          }
          if (-not $exe64) {
            Write-Error "No .exe found in artifacts\x64 or PUBG_mortar\\artifacts\x64"
            exit 1
          }
          $searchPaths86 = @('artifacts\x86','PUBG_mortar\artifacts\x86')
          $exe86 = $null
          foreach ($p in $searchPaths86) {
            if (Test-Path $p) {
              $exe86 = Get-ChildItem -Path $p -Filter *.exe -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
              if ($exe86) { break }
            }
          }
          if (-not $exe86) {
            Write-Error "No .exe found in artifacts\x86 or PUBG_mortar\\artifacts\x86"
            exit 1
          }
          Write-Host "Found x64 exe: $($exe64.FullName)"
          Write-Host "Found Win32 exe: $($exe86.FullName)"
          Copy-Item -Path $exe64.FullName -Destination artifacts\release\PUBG_MAP.exe -Force
          Copy-Item -Path $exe86.FullName -Destination artifacts\release\PUBG_MAP-console.exe -Force

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: PUBG_MAP-build
          path: artifacts\release\
